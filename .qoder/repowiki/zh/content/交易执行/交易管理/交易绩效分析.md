# 交易绩效分析

<cite>
**本文档中引用的文件**  
- [trades.py](file://investing_algorithm_framework/services/metrics/trades.py)
- [trade_metrics_table.py](file://investing_algorithm_framework/app/reporting/tables/trade_metrics_table.py)
- [trades_table.py](file://investing_algorithm_framework/app/reporting/tables/trades_table.py)
- [backtest_metrics.py](file://investing_algorithm_framework/domain/backtesting/backtest_metrics.py)
- [generate.py](file://investing_algorithm_framework/services/metrics/generate.py)
</cite>

## 目录
1. [引言](#引言)
2. [交易指标计算逻辑](#交易指标计算逻辑)
3. [交易绩效表格展示](#交易绩效表格展示)
4. [交易历史记录表格展示](#交易历史记录表格展示)
5. [API查询与数据导出示例](#api查询与数据导出示例)
6. [算法细节与性能优化](#算法细节与性能优化)
7. [结论](#结论)

## 引言
本文件系统介绍了投资算法框架中的交易绩效分析功能。该功能通过计算和展示关键交易指标，帮助用户深入理解交易策略的实际表现。系统实现了盈亏比、胜率、平均持仓时间等核心指标的计算，并通过格式化的表格呈现交易绩效数据和详细的交易历史记录。本文档详细解释了各项指标的计算逻辑、数据呈现方式以及API使用方法，为用户提供全面的交易绩效分析指导。

## 交易指标计算逻辑

交易绩效分析的核心是`trades.py`文件中实现的各项指标计算函数。这些函数基于交易对象列表，计算出反映策略表现的关键指标。

### 盈亏比与胜率计算
盈亏比（Win/Loss Ratio）和胜率（Win Rate）是评估交易策略质量的核心指标。系统通过以下方式计算：

- **胜率**：通过`get_positive_trades`函数计算盈利交易的数量和百分比。该函数筛选出状态为"已关闭"且净收益为正的交易，计算其占所有已关闭交易的比例。
- **盈亏比**：通过`get_average_trade_gain`和`get_average_trade_loss`函数分别计算平均盈利和平均亏损，然后求得比率。平均盈利是所有盈利交易净收益的算术平均值，平均亏损是所有亏损交易净收益绝对值的算术平均值。

这些指标的计算严格区分已关闭交易和包含未平仓交易的当前状态，提供了历史表现和实时表现的双重视角。

**Section sources**
- [trades.py](file://investing_algorithm_framework/services/metrics/trades.py#L7-L70)

### 平均持仓时间计算
平均持仓时间反映了策略的交易频率和持仓策略。系统通过`get_average_trade_duration`函数实现计算：

该函数遍历所有交易，对于已关闭的交易，计算其`closed_at`与`opened_at`之间的时间差（以小时为单位）；对于未平仓交易，则不计入计算。所有已关闭交易的持仓时间总和除以已关闭交易数量，得到平均持仓时间。

此外，系统还提供了`get_current_average_trade_duration`函数，该函数将未平仓交易的持仓时间计算至回测结束时间，为实时监控提供更全面的视角。

**Section sources**
- [trades.py](file://investing_algorithm_framework/services/metrics/trades.py#L138-L198)

### 其他关键指标
系统还实现了多个辅助指标的计算：

- **交易总数**：通过`get_number_of_trades`函数获取所有交易的数量。
- **开仓交易数**：通过`get_number_of_open_trades`函数获取状态为"进行中"的交易数量。
- **平仓交易数**：通过`get_number_of_closed_trades`函数获取状态为"已关闭"的交易数量。
- **平均交易规模**：通过`get_average_trade_size`函数计算，基于每笔交易的数量和开仓价格的乘积求平均值。
- **最佳与最差交易**：通过`get_best_trade`和`get_worst_trade`函数分别找出净收益最高和最低的交易。

这些指标共同构成了全面的交易绩效评估体系。

**Section sources**
- [trades.py](file://investing_algorithm_framework/services/metrics/trades.py#L73-L136)
- [trades.py](file://investing_algorithm_framework/services/metrics/trades.py#L201-L227)
- [trades.py](file://investing_algorithm_framework/services/metrics/trades.py#L469-L500)

## 交易绩效表格展示

`trade_metrics_table.py`文件中的`create_html_trade_metrics_table`函数负责将计算出的交易指标格式化为可读性强的HTML表格。

### 表格结构与内容
该函数创建的表格包含以下关键指标：
- 年交易次数和日交易次数
- 暴露比率和累计暴露
- 平均交易盈利和平均交易亏损
- 最佳交易和最差交易（包括收益金额和开仓日期）
- 平均持仓时间
- 交易总数
- 胜率和盈亏比

表格通过`pandas.DataFrame`组织数据，并应用了丰富的样式，包括交替行背景色和表头加粗，提高了可读性。

### 条件格式化
系统实现了智能的条件格式化功能，通过`highlight_win_rate`和`highlight_win_loss_ratio`函数，根据指标值的优劣自动改变文本颜色：

- **胜率**：低于40%显示为红色（差），40%-50%为橙色（弱），50%-60%为金色（平均），60%-70%为亮绿色（好），高于70%为深绿色（优秀）。
- **盈亏比**：低于0.5为红色（差），0.5-1.0为橙色（弱），1.0-1.5为金色（平均），1.5-2.0为亮绿色（好），高于2.0为深绿色（优秀）。

这种视觉提示帮助用户快速识别策略的强弱项。

**Section sources**
- [trade_metrics_table.py](file://investing_algorithm_framework/app/reporting/tables/trade_metrics_table.py#L67-L147)

## 交易历史记录表格展示

`trades_table.py`文件中的`create_html_trades_table`函数负责展示详细的交易历史记录。

### 表格列设计
该表格为每笔交易提供以下信息：
- **交易**：交易ID和交易对（目标资产/交易资产）
- **净收益**：以金额和百分比形式显示的净收益
- **入场（价格，日期）**：开仓价格和开仓时间
- **出场（价格，日期）**：对于已平仓交易显示平仓时间和价格，对于未平仓交易显示"open"
- **持仓时间**：以小时为单位的持仓时长

### 数据格式化与高亮
系统通过`get_exit`辅助函数处理平仓信息的显示逻辑，确保已平仓和未平仓交易都能正确呈现。`highlight_net_gain`函数实现了基于收益百分比的条件格式化：

- 收益低于-5%：红色
- -5%至-2%：橙色
- -2%至0%：金色
- 0%至5%：亮绿色
- 高于5%：深绿色

这种颜色编码使用户能快速识别每笔交易的表现。

**Section sources**
- [trades_table.py](file://investing_algorithm_framework/app/reporting/tables/trades_table.py#L50-L75)

## API查询与数据导出示例

虽然当前代码库中未直接提供交易绩效的API端点，但系统通过服务层和Web控制器的架构，为API查询和数据导出提供了基础。

### 数据查询流程
1. 通过`trade_service`获取交易数据
2. 调用`services/metrics`中的计算函数生成指标
3. 使用`reporting/tables`中的函数将数据格式化为表格
4. 通过Web响应返回结果

### 导出示例
```python
# 假设的API调用示例
from investing_algorithm_framework.services.metrics import trades
from investing_algorithm_framework.app.reporting.tables import trade_metrics_table

# 获取交易数据（实际中通过服务层获取）
trades_list = trade_service.get_all()

# 计算关键指标
win_rate = trades.get_positive_trades(trades_list)[1]
win_loss_ratio = trades.get_average_trade_gain(trades_list)[0] / abs(trades.get_average_trade_loss(trades_list)[0])

# 生成HTML表格
results = {
    'win_rate': win_rate,
    'win_loss_ratio': win_loss_ratio,
    # ... 其他指标
}
html_table = trade_metrics_table.create_html_trade_metrics_table(results, report)

# 导出为文件
with open('trade_performance.html', 'w') as f:
    f.write(html_table)
```

**Section sources**
- [trades.py](file://investing_algorithm_framework/services/metrics/trades.py)
- [trade_metrics_table.py](file://investing_algorithm_framework/app/reporting/tables/trade_metrics_table.py)

## 算法细节与性能优化

### 指标计算算法
交易指标的计算采用了高效的算法设计：
- 所有计算函数都基于单次遍历交易列表，时间复杂度为O(n)
- 使用列表推导式和内置函数（如`sum`、`max`、`min`）提高计算效率
- 对空列表和None值进行异常处理，确保计算的健壮性

### 数据聚合方法
系统通过`backtest_metrics.py`中的`BacktestMetrics`类实现了指标的聚合。该类在初始化时调用`services/metrics`中的各个函数，将计算结果存储为属性，便于后续访问和序列化。

### 性能优化策略
- **缓存机制**：关键指标在回测完成后计算一次并缓存，避免重复计算
- **惰性计算**：某些复杂指标（如月度收益统计）仅在需要时计算
- **批量处理**：使用pandas进行数据处理，利用其向量化操作提高性能
- **内存优化**：避免在计算过程中创建不必要的中间对象

这些优化确保了即使在处理大量交易数据时，系统也能保持良好的性能。

**Section sources**
- [trades.py](file://investing_algorithm_framework/services/metrics/trades.py)
- [backtest_metrics.py](file://investing_algorithm_framework/domain/backtesting/backtest_metrics.py)
- [generate.py](file://investing_algorithm_framework/services/metrics/generate.py)

## 结论
本交易绩效分析系统提供了一套完整的交易策略评估工具。通过精确计算盈亏比、胜率、平均持仓时间等关键指标，并以直观的表格形式展示，用户能够全面了解策略的表现。系统的模块化设计和高效的算法确保了分析的准确性和性能。未来可以通过增加更多高级指标（如夏普比率、最大回撤）和交互式可视化功能，进一步提升分析能力。