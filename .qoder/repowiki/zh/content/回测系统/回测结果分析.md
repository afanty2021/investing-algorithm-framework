# 回测结果分析

<cite>
**本文档引用的文件**   
- [generate.py](file://investing_algorithm_framework/services/metrics/generate.py)
- [sharpe_ratio.py](file://investing_algorithm_framework/services/metrics/sharpe_ratio.py)
- [sortino_ratio.py](file://investing_algorithm_framework/services/metrics/sortino_ratio.py)
- [calmar_ratio.py](file://investing_algorithm_framework/services/metrics/calmar_ratio.py)
- [volatility.py](file://investing_algorithm_framework/services/metrics/volatility.py)
- [drawdown.py](file://investing_algorithm_framework/services/metrics/drawdown.py)
- [win_rate.py](file://investing_algorithm_framework/services/metrics/win_rate.py)
- [profit_factor.py](file://investing_algorithm_framework/services/metrics/profit_factor.py)
- [exposure.py](file://investing_algorithm_framework/services/metrics/exposure.py)
- [cagr.py](file://investing_algorithm_framework/services/metrics/cagr.py)
- [trades.py](file://investing_algorithm_framework/services/metrics/trades.py)
- [backtest_metrics.py](file://investing_algorithm_framework/domain/backtesting/backtest_metrics.py)
- [run_backtest.ipynb](file://examples/backtest_example/run_backtest.ipynb)
</cite>

## 目录
1. [引言](#引言)
2. [核心性能指标](#核心性能指标)
3. [风险调整收益指标](#风险调整收益指标)
4. [核心风险与交易指标](#核心风险与交易指标)
5. [时间相关指标](#时间相关指标)
6. [自定义指标扩展](#自定义指标扩展)
7. [多策略比较与参数敏感性分析](#多策略比较与参数敏感性分析)
8. [边界情况处理](#边界情况处理)
9. [结论](#结论)

## 引言
本文件旨在提供对投资算法框架中回测结果分析的全面文档。文档详细阐述了所有关键性能指标的计算方法和业务意义，包括夏普比率、卡玛比率、索提诺比率等风险调整收益指标的数学公式和实现代码。同时，文档描述了最大回撤、波动率、胜率和盈亏比等核心指标的计算逻辑，以及年化收益率、CAGR和暴露时间等时间相关指标的评估方法。此外，文档还提供了自定义指标扩展的开发指南，展示了使用Jupyter Notebook进行多策略比较和参数敏感性分析的工作流程，并包含处理异常结果（如无限夏普比率）的边界情况处理说明。

**Section sources**
- [run_backtest.ipynb](file://examples/backtest_example/run_backtest.ipynb)

## 核心性能指标
回测结果分析的核心在于一系列关键性能指标的计算和解释。这些指标共同构成了评估交易策略表现的完整框架。系统通过`BacktestMetrics`类来组织和存储所有计算结果，该类定义了包括最终价值、总增长、年化增长率（CAGR）、夏普比率、卡玛比率、最大回撤、胜率和盈亏比等在内的40多个属性。这些指标的计算由`investing_algorithm_framework.services.metrics.generate`模块中的`create_backtest_metrics`函数统一协调，该函数根据预设的指标列表，调用各个独立的指标计算函数来填充`BacktestMetrics`对象。

**Section sources**
- [backtest_metrics.py](file://investing_algorithm_framework/domain/backtesting/backtest_metrics.py)
- [generate.py](file://investing_algorithm_framework/services/metrics/generate.py)

## 风险调整收益指标

### 夏普比率
夏普比率是衡量风险调整后收益的核心指标，它表示每单位总风险（以波动率衡量）所获得的超额回报。其计算公式为：
```
夏普比率 = (年化收益率 - 无风险利率) / 年化波动率
```
在本框架中，该比率基于日收益率计算，并进行年化处理。具体实现位于`sharpe_ratio.py`文件的`get_sharpe_ratio`函数中。该函数首先计算日收益率的均值和标准差，然后使用365作为年化因子，将结果转换为年化夏普比率。当标准差为零时，为避免除零错误，函数返回`NaN`。

| 夏普比率 | 解释 |
| -------------- | ------------------------------------------- |
| **< 0** | 差：表现不如无风险资产 |
| **0.0 – 1.0** | 次优：回报不足以证明风险的合理性 |
| **1.0 – 1.99** | 可接受：合理的风险调整回报 |
| **2.0 – 2.99** | 良好：强劲的风险调整表现 |
| **3.0+** | 优秀：卓越的风险调整回报 |

**Section sources**
- [sharpe_ratio.py](file://investing_algorithm_framework/services/metrics/sharpe_ratio.py)

### 卡玛比率
卡玛比率是衡量风险调整后收益的另一重要指标，它将年化收益率与最大回撤进行比较。其计算公式为：
```
卡玛比率 = CAGR / 最大回撤
```
该比率越高，表明策略在承担单位回撤风险时获得的回报越高。实现位于`calmar_ratio.py`文件的`get_calmar_ratio`函数中。该函数直接调用`get_cagr`和`get_max_drawdown`函数获取所需数据。当最大回撤为零或为空时，函数返回0.0以避免除零错误。

| 卡玛比率 | 解释 |
| ---------------- | ----------------------------------------------------------- |
| **> 3.0** | **优秀** – 相对于回撤，回报强劲 |
| **2.0 – 3.0** | **非常好** – 健全的风险回报表现 |
| **1.0 – 2.0** | **可接受** – 尤其适用于波动性策略 |
| **< 1.0** | **差** – 回撤相对于回报过高 |

**Section sources**
- [calmar_ratio.py](file://investing_algorithm_framework/services/metrics/calmar_ratio.py)

### 索提诺比率
索提诺比率是夏普比率的改进版本，它只关注下行风险（即负收益的波动率），而非总波动率。这使得它在评估收益分布不对称的策略时更为有效。其计算公式为：
```
索提诺比率 = (年化收益率 - 无风险利率) / 下行标准差
```
实现位于`sortino_ratio.py`文件的`get_sortino_ratio`函数中。该函数利用`get_downside_std_of_daily_returns`函数计算下行标准差。当下行标准差为零时，函数返回`NaN`。

| **索提诺比率** | **解释** |
|-------------------|----------------------------------------------------------------------|
| **< 0** | 🚫 差 — 投资组合表现不如无风险利率且存在下行风险 |
| **0 to 1** | ⚠️ 次优 — 相对于下行风险，超额回报较低 |
| **1 to 2** | ✅ 可接受/良好 — 大多数投资组合的合理表现 |
| **2 to 3** | 💪 强劲 — 非常好的风险调整回报 |
| **> 3** | 🌟 优秀 — 罕见，可能表明策略异常或过拟合 |

**Section sources**
- [sortino_ratio.py](file://investing_algorithm_framework/services/metrics/sortino_ratio.py)

## 核心风险与交易指标

### 最大回撤
最大回撤（MDD）是衡量策略在历史回测中从峰值到谷底的最大损失，是评估策略风险的关键指标。框架提供了多个相关函数：
- `get_max_drawdown`: 计算以百分比表示的最大回撤。
- `get_max_drawdown_absolute`: 计算以绝对金额表示的最大回撤。
- `get_max_drawdown_duration`: 计算最大回撤持续的天数。
- `get_drawdown_series`: 计算整个回测期间的回撤序列。

这些函数位于`drawdown.py`文件中，通过追踪权益曲线的峰值并计算后续谷底的跌幅来实现。

| **最大回撤 (%)** | **解释** |
|-----------------------|----------------------------------------------------------------------|
| **0% to -5%** | 🟢 优秀 — 风险极低，典型于保守策略 |
| **-5% to -10%** | ✅ 良好 — 波动适中，适用于平衡型投资组合 |
| **-10% to -20%** | ⚠️ 风险升高 — 常见于成长型或主动管理策略 |
| **-20% to -40%** | 🔻 高风险 — 重大回撤，典型于激进策略 |
| **> -40%** | 🚨 风险极高 — 资本损失或策略失败的风险 |

**Section sources**
- [drawdown.py](file://investing_algorithm_framework/services/metrics/drawdown.py)

### 波动率
年化波动率是衡量投资组合价值波动程度的统计指标，通常作为风险的代理。实现位于`volatility.py`文件的`get_annual_volatility`函数中。该函数首先将投资组合快照按天重采样，然后计算每日对数收益率的标准差，并乘以√365进行年化。

| **年化波动率** | **风险水平 (独立)** | **夏普比率影响** | **评论** |
| --------------------- | --------------------------- | ---------------------------------------- | ----------- |
| **< 5%** | 风险极低 | 夏普 > 2.0 = 优秀<br>夏普 < 0.5 = 差 | 低波动性很好，除非回报为负 |
| **5% – 10%** | 低风险 | 夏普 > 1.0 = 良好<br>夏普 < 0.3 = 平庸 | 典型于保守型投资组合 |
| **10% – 15%** | 中等风险 | 夏普 > 0.8 = 良好<br>夏普 < 0.2 = 有风险 | 标普500基准；质量很重要 |
| **15% – 25%** | 高风险 | 夏普 > 0.6 = 可接受<br>夏普 < 0.0 = 避免 | **示例：30% CAGR + 23% 波动率 = 夏普 ~1.3 = 优秀** |
| **> 25%** | 风险极高 | 夏普 > 0.4 = 或许可接受<br>夏普 < 0.0 = 危险 | 仅在有强劲正回报时可行 |

**Section sources**
- [volatility.py](file://investing_algorithm_framework/services/metrics/volatility.py)

### 胜率与盈亏比
胜率和盈亏比是评估交易策略盈利能力的两个互补指标。
- **胜率**: 盈利交易占总交易数的百分比。计算公式为：`胜率 = 盈利交易数 / 总交易数`。
- **盈亏比**: 盈利交易的平均盈利与亏损交易的平均亏损之比。计算公式为：`盈亏比 = 平均盈利 / 平均亏损`。

这两个指标的计算函数位于`win_rate.py`文件中。单独看任何一个指标都可能产生误导，必须结合分析。例如，一个胜率高但盈亏比低的策略，可能因为少数大额亏损而整体亏损。

| 胜率 | 盈亏比 | 评论 |
| ----------------- | -------------- | ---------------------------------- |
| 高 (>60%) | <1 | 仍可能盈利 |
| 中等 (40-60%) | \~1 或 >1 | 理想的平衡点 |
| 低 (<40%) | >1 | 如果大额盈利能抵消亏损，则可能盈利 |

**Section sources**
- [win_rate.py](file://investing_algorithm_framework/services/metrics/win_rate.py)

### 盈利因子
盈利因子是衡量策略盈利能力的指标，计算公式为：
```
盈利因子 = 总盈利 / 总亏损
```
该指标位于`profit_factor.py`文件中。一个大于1.0的盈利因子通常表示策略是盈利的。当总亏损为零时，如果总盈利为正，则返回`inf`；如果总盈利也为零，则返回0.0。

| **盈利因子** | **解释** |
| ----------------- | ----------------------------------------------------------------------------------------- |
| **< 1.0** | **亏损策略** — 亏损超过盈利 |
| **1.0 – 1.3** | 弱或勉强盈亏平衡 — 需要改进或可能不可持续 |
| **1.3 – 1.6** | 平均 — 可能盈利，但对市场状况变化敏感 |
| **1.6 – 2.0** | 良好 — 通常表明有稳固的优势 |
| **2.0 – 3.0** | 非常好 — 强劲的优势，回撤风险较低 |
| **> 3.0** | 优秀 — 在真实市场中罕见；通常与低频或小众策略相关 |

**Section sources**
- [profit_factor.py](file://investing_algorithm_framework/services/metrics/profit_factor.py)

## 时间相关指标

### 年化收益率与CAGR
年化收益率，特别是复合年增长率（CAGR），是评估投资表现的核心指标。CAGR将投资回报标准化为一年的基准，允许跨不同时间段进行比较。其计算公式为：
```
CAGR = (最终价值 / 初始价值) ^ (365 / 天数) - 1
```
该公式适用于任何时间段（少于、等于或多于一年）。实现位于`cagr.py`文件的`get_cagr`函数中。

**Section sources**
- [cagr.py](file://investing_algorithm_framework/services/metrics/cagr.py)

### 暴露时间
暴露时间衡量策略在市场中的活跃程度。
- **暴露比率 (exposure_ratio)**: 衡量策略在回测期间有至少一个头寸开放的时间比例。结果在0到1之间。
- **累积暴露 (cumulative_exposure)**: 衡量策略的总资本部署时间。如果策略有重叠的交易，此值可能大于1。

这两个指标的计算函数位于`exposure.py`文件中。高暴露比率（>1）意味着策略积极地部署资本。

**Section sources**
- [exposure.py](file://investing_algorithm_framework/services/metrics/exposure.py)

## 自定义指标扩展
本框架支持通过创建新的指标计算函数来扩展指标集。开发人员可以遵循现有指标模块（如`sharpe_ratio.py`）的模式，创建一个接受`snapshots`或`trades`列表作为输入并返回计算结果的函数。然后，可以在`generate.py`文件的`create_backtest_metrics`函数的默认指标列表中添加该函数的名称，使其被自动调用。新指标的计算结果将被存储在`BacktestMetrics`对象的相应属性中。

**Section sources**
- [generate.py](file://investing_algorithm_framework/services/metrics/generate.py)

## 多策略比较与参数敏感性分析
框架提供了使用Jupyter Notebook进行多策略比较和参数敏感性分析的工作流程。`run_backtest.ipynb`示例展示了如何动态加载策略、下载数据、运行回测并生成报告。用户可以定义不同的参数组合，对每个组合运行回测，并将结果汇总比较，以识别最优参数和稳健的策略。`evaluation.ipynb`文件进一步展示了如何准备数据、运行回测并输出关键指标（如夏普比率、最大回撤、胜率等）进行比较。

**Section sources**
- [run_backtest.ipynb](file://examples/backtest_example/run_backtest.ipynb)

## 边界情况处理
在计算指标时，系统会处理各种边界情况以确保鲁棒性。
- **除零错误**: 在计算夏普比率、索提诺比率、盈亏比和盈利因子时，如果分母（如标准差、亏损额）为零，函数会返回`NaN`、`inf`或0.0，并记录警告。
- **数据不足**: 对于需要至少两个快照的指标（如CAGR、总回报），如果输入数据不足，函数会返回0.0。
- **空输入**: 大多数函数在接收到空的`trades`或`snapshots`列表时会抛出`OperationalException`或返回0.0。

**Section sources**
- [sharpe_ratio.py](file://investing_algorithm_framework/services/metrics/sharpe_ratio.py)
- [sortino_ratio.py](file://investing_algorithm_framework/services/metrics/sortino_ratio.py)
- [win_rate.py](file://investing_algorithm_framework/services/metrics/win_rate.py)
- [profit_factor.py](file://investing_algorithm_framework/services/metrics/profit_factor.py)

## 结论
本框架提供了一套全面且稳健的回测结果分析工具。通过将复杂的金融指标计算分解为独立的、可测试的函数，并通过`BacktestMetrics`类进行统一管理，系统实现了高内聚、低耦合的设计。文档详细说明了夏普比率、卡玛比率、索提诺比率等风险调整收益指标，以及最大回撤、波动率、胜率和盈亏比等核心风险指标的计算逻辑和业务意义。同时，也涵盖了CAGR、暴露时间等时间相关指标的评估方法。该框架不仅支持标准指标的计算，还提供了清晰的扩展路径以支持自定义指标，并通过Jupyter Notebook示例展示了多策略比较和参数敏感性分析的强大工作流程。最后，系统内置了对无限夏普比率等边界情况的处理，确保了分析结果的可靠性和稳定性。